<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>四杆机构参数计算器 · Crank–Rocker 4‑Bar</title>
  <style>
    :root{ --bg:#0b0f14;--fg:#e8edf2;--muted:#9fb0c3;--accent:#59c;--danger:#ff6b6b;--ok:#2ecc71;--card:#121821;--line:#1d2633; }
    *{box-sizing:border-box}
    body{margin:0;font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:var(--fg);background:linear-gradient(180deg,#0b0f14,#0f1622) fixed;}
    h1{font-size:20px;margin:8px 0 0}
    .wrap{max-width:1100px;margin:0 auto;padding:20px}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);grid-gap:12px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;box-shadow:0 6px 20px rgba(0,0,0,.25)}
    .col-4{grid-column:span 4}.col-8{grid-column:span 8}.col-6{grid-column:span 6}.col-12{grid-column:span 12}
    label{display:block;font-weight:600;margin-bottom:6px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    input[type="number"], select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:#0c131d;color:var(--fg)}
    input[type="range"]{width:100%}
    small{color:var(--muted)}
    button{appearance:none;border:0;border-radius:12px;padding:10px 14px;background:var(--accent);color:#fff;font-weight:700;cursor:pointer}
    button.secondary{background:#2b3546}
    button.ghost{background:transparent;border:1px dashed var(--line)}
    .pill{background:#152234;border:1px solid #1e2c44;border-radius:999px;padding:6px 10px;display:inline-flex;gap:8px;align-items:center}
    .warn{color:var(--danger)}
    .ok{color:var(--ok)}
    code{background:#0e1520;border:1px solid var(--line);padding:2px 6px;border-radius:6px}
    kbd{background:#0f1825;border:1px solid var(--line);padding:2px 6px;border-radius:6px}
    .results-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
    .metric{background:#0e1520;border:1px solid var(--line);border-radius:12px;padding:10px}
    .metric h3{margin:0 0 6px;font-size:12px;color:var(--muted);font-weight:600}
    .metric .val{font-size:20px;font-weight:800}
    .muted{color:var(--muted)}
    .divider{border-top:1px dashed var(--line);margin:10px 0}
    .badge{font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid var(--line);background:#101827;color:var(--muted)}
    .svgwrap{background:#0b111a;border:1px solid var(--line);border-radius:12px;overflow:hidden;height:360px}
    .legend{display:flex;gap:12px;flex-wrap:wrap}
    .legend .dot{width:10px;height:10px;border-radius:50%}
    .row > .grow{flex:1}
    pre#testLog{background:#0e1520;border:1px solid var(--line);border-radius:10px;padding:10px;max-height:220px;overflow:auto}
    /* —— 放大主参数输入框 —— */
    .param-grid input[type="number"]{font-size:18px;padding:14px 16px;border-radius:12px}
    @media (max-width: 760px){ .param-grid .col-6{grid-column:span 12} }
    /* 保障交互：防止意外覆盖导致控件无法点击/拖动 */
    .card, .card * { pointer-events: auto; }
    .svgwrap { position: relative; z-index: 0; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="grid">
      <div class="card col-8">
        <div class="row" style="justify-content:space-between;align-items:flex-start">
          <div>
            <h1>四杆机构参数计算器 <span class="badge">Crank–Rocker 4‑bar</span></h1>
            <div class="muted">填入已知参数（留空或填 0 表示未知）。点击「计算」后，程序会：① 自动生成未知量的滑块供你调节；② 实时计算 <b>摇杆摆角</b> 与 <b>行程速度变化系数 K（快返比）</b>。<br>默认 O₂(0,0)、O₄(d,0)。单位：长度 mm，角度 °。</div>
          </div>
          <div class="pill">装配型式：
            <label class="row"><input type="radio" name="asm" value="open" checked> 开式</label>
            <label class="row"><input type="radio" name="asm" value="cross"> 交叉式</label>
          </div>
        </div>

        <div class="grid param-grid" style="margin-top:10px">
          <div class="col-6">
            <label>曲柄 a (mm)</label>
            <input id="a" type="number" placeholder="例如 30" step="0.01" />
            <small>Crank</small>
          </div>
          <div class="col-6">
            <label>连杆 b (mm)</label>
            <input id="b" type="number" placeholder="例如 70" step="0.01" />
            <small>Coupler</small>
          </div>
          <div class="col-6">
            <label>摇杆 c (mm)</label>
            <input id="c" type="number" placeholder="例如 60" step="0.01" />
            <small>Rocker</small>
          </div>
          <div class="col-6">
            <label>机架 d (mm)</label>
            <input id="d" type="number" placeholder="例如 90" step="0.01" />
            <small>Ground</small>
          </div>
        </div>

        <!-- 目标约束：摇杆摆角与快返比 K 可作为输入 -->
        <div class="card" style="margin-top:10px">
          <div class="row" style="justify-content:space-between;align-items:center">
            <b>可选目标约束</b>
            <small class="muted">勾选后可将 <b>摇杆摆角</b> 或 <b>K</b> 作为目标来反推一个未知杆长（当且仅当 a/b/c/d 恰好有一个未知时自动求解）。</small>
          </div>
          <div class="grid" style="margin-top:6px">
            <div class="col-6">
              <label>目标·摇杆摆角 (°)
                <span class="pill" style="margin-left:8px"><input id="useSwing" type="checkbox"/> 作为约束</span>
              </label>
              <input id="swingTarget" type="number" placeholder="例如 40（表示 φmax−φmin）" step="0.01" />
            </div>
            <div class="col-6">
              <label>目标·行程速度变化系数 K
                <span class="pill" style="margin-left:8px"><input id="useK" type="checkbox"/> 作为约束</span>
              </label>
              <input id="KTarget" type="number" placeholder="例如 1.40（快返比）" step="0.001" />
            </div>
          </div>
        </div>

        <div class="row" style="margin-top:10px;gap:10px">
          <button id="calc">计算</button>
          <button id="reset" class="secondary">清空</button>
          <span class="muted">提示：未知或不唯一 → 自动生成滑块。</span>
        </div>

        <div id="sliders" class="card" style="margin-top:12px;display:none">
          <div class="row" style="justify-content:space-between"><b>自动生成的未知参数滑块</b><small class="muted">拖动以补全未填参数</small></div>
          <div id="sliderFields" class="grid" style="margin-top:6px"></div>
        </div>

        <div class="card" style="margin-top:12px">
          <div class="row" style="justify-content:space-between;align-items:center">
            <b>机构预览 & 输入曲柄角 θ（仅在可装配范围内生效）</b>
            <div class="legend">
              <span class="row"><span class="dot" style="background:#89b4fa"></span><small>曲柄 a</small></span>
              <span class="row"><span class="dot" style="background:#a6e3a1"></span><small>连杆 b</small></span>
              <span class="row"><span class="dot" style="background:#f9e2af"></span><small>摇杆 c</small></span>
              <span class="row"><span class="dot" style="background:#eba0ac"></span><small>机架 d</small></span>
            </div>
          </div>
          <div class="row" style="gap:10px;align-items:center;margin-top:6px">
            <input id="thetaRange" type="range" min="0" max="360" value="0" step="0.1" class="grow" />
            <div style="min-width:120px"><code>θ = <span id="thetaLbl">0</span>°</code></div>
          </div>
          <div class="svgwrap" style="margin-top:8px">
            <svg id="svg" viewBox="-20 -80 260 200" width="100%" height="100%">
              <defs>
                <marker id="dot" markerWidth="6" markerHeight="6" refX="3" refY="3">
                  <circle cx="3" cy="3" r="3" fill="#94a3b8" />
                </marker>
              </defs>
              <rect x="-1000" y="-1000" width="2000" height="2000" fill="#0b111a" />
              <g id="axes" stroke="#1f2a3a" stroke-width="0.8">
                <line x1="-1000" y1="0" x2="1000" y2="0" />
                <line x1="0" y1="-1000" x2="0" y2="1000" />
              </g>
              <g id="mech" stroke-width="3" stroke-linecap="round" fill="none">
                <line id="linkA" stroke="#89b4fa" marker-start="url(#dot)" marker-end="url(#dot)" />
                <line id="linkB" stroke="#a6e3a1" marker-start="url(#dot)" marker-end="url(#dot)" />
                <line id="linkC" stroke="#f9e2af" marker-start="url(#dot)" marker-end="url(#dot)" />
                <line id="linkD" stroke="#eba0ac" marker-start="url(#dot)" marker-end="url(#dot)" />
              </g>
            </svg>
          </div>
          <div class="row" style="margin-top:6px"><small class="muted">拖动 θ 观察机构姿态；当两圆相切即为极限位（死点）。</small></div>
        </div>
      </div>

      <div class="card col-4">
        <b>计算结果</b>
        <div class="divider"></div>
        <div class="results-grid">
          <div class="metric"><h3>a 是否可整周</h3><div class="val" id="crankA">—</div><small class="muted"><span id="crankACov">—</span> 的 θ 可装配</small></div>
          <div class="metric"><h3>摇杆摆角 φ<sub>max</sub>−φ<sub>min</sub></h3><div class="val" id="swing">—</div><small class="muted">单位：°</small></div>
          <div class="metric"><h3>机构判别 · Grashof 条件</h3><div class="val" id="classify">—</div><small class="muted">判别结果</small></div>
          <div class="metric"><h3>行程速度变化系数 K</h3><div class="val" id="qrr">—</div><small class="muted">快返比（回程角/去程角）</small></div>
        </div>
        
        <div class="divider"></div>
        <div>
          <div class="row" style="justify-content:space-between"><b>可复制 JSON</b><button id="copy" class="ghost">复制</button></div>
          <pre id="json" style="white-space:pre-wrap;word-break:break-all;background:#0e1520;border:1px solid var(--line);border-radius:10px;padding:10px;margin:8px 0 0;max-height:220px;overflow:auto">{}</pre>
        </div>
        <div class="divider"></div>
        <div>
          <div class="row" style="justify-content:space-between;align-items:center"><b>内置测试</b><button id="runTests" class="ghost">运行测试</button></div>
          <pre id="testLog">(测试输出)</pre>
        </div>
      </div>
    </div>

    <div class="card col-12" style="margin-top:12px">
      <b>说明</b>
      <ul>
        <li>未知/未填/=0 的长度参数会自动生成滑块（范围依据已知尺度推断）。</li>
        <li>计算基于圆圆相交的几何法：B 为曲柄端点，C 为连杆-摇杆铰点；满足 |BC|=b, |O₄C|=c。</li>
        <li>极限位（死点）发生在两圆外切/内切：r=|O₄−B|=b±c；对应曲柄角满足 <code>cosθ=(a²+d²−r²)/(2ad)</code>。</li>
        <li>K 为快返比（回程角/去程角）。当 K≠1 表示存在快返效应。</li>
        <li>当几何不可装配或非 Grashof 条件导致曲柄不能整周转时，θ 预览仅在可装配区间内有效。</li>
      </ul>
      <div class="divider"></div>
      <small class="muted">当勾选“作为约束”且 a/b/c/d 中恰好一个未知时，程序会在合理范围内用数值搜索反推该未知杆长，使计算得到的摆角和/或 K 尽量贴近目标；若无解或多解，将保持滑块供你手动微调。</small>
    </div>
  </div>

<script>
(function(){
'use strict';
// ====== 工具函数 ======
function $(sel){ return document.querySelector(sel); }
function $$(sel){ return Array.prototype.slice.call(document.querySelectorAll(sel)); }
function rad(d){ return d*Math.PI/180; } function deg(r){ return r*180/Math.PI; }
function getAsm(){ var els=document.querySelectorAll('input[name="asm"]'); for(var i=0;i<els.length;i++){ if(els[i].checked) return els[i].value; } return 'open'; }
function readNumSel(sel){ var el=$(sel); if(!el) return null; var v=parseFloat(el.value); return isNaN(v)? null : v; }
function readInOr(selIn, selBase){ var v=readNumSel(selIn); return (v!=null)? v : readNumSel(selBase); }
function parseVal(sel){ var el=$(sel); if(!el) return null; var v=parseFloat(el.value); return (isNaN(v) || v===0)? null : v; }
function niceNum(x, d){ if(d===void 0) d=4; if(!isFinite(x)) return '—'; var abs=Math.abs(x); if(abs>=1e4||abs<1e-3) return x.toExponential(3); return x.toFixed(d).replace(/\.0+$/,'').replace(/(\.\d*?)0+$/,'$1'); }
function setText(sel, val){ var el=$(sel); if(el) el.textContent = val; }
function setHTML(sel, val){ var el=$(sel); if(el) el.innerHTML = val; }

// ====== 核心几何 ======
function circleIntersections(x0,y0,r0,x1,y1,r1){ var dx=x1-x0, dy=y1-y0; var d=Math.hypot(dx,dy); if(d>r0+r1+1e-9) return []; if(d<Math.abs(r0-r1)-1e-9) return []; if(d<1e-12) return []; var a=(r0*r0 - r1*r1 + d*d)/(2*d); var h2=r0*r0 - a*a; if(h2<-1e-9) return []; var h=Math.sqrt(Math.max(0,h2)); var xm=x0 + a*dx/d; var ym=y0 + a*dy/d; var rx=-dy*(h/d); var ry=dx*(h/d); var p1={x:xm+rx, y:ym+ry}; var p2={x:xm-rx, y:ym-ry}; return [p1,p2]; }
function choosePoint(p1,p2,mode){ if(!p2) return p1; return (mode==='open') ? (p1.y>=p2.y? p1:p2) : (p1.y<=p2.y? p1:p2); }
function classifyGrashof(a,b,c,d){ var arr=[a,b,c,d].slice().sort(function(x,y){return x-y;}); var S=arr[0], L=arr[3], P=arr[1], Q=arr[2]; var g = S+L <= P+Q ? 'Grashof' : 'Non‑Grashof'; return {type:g, S:S, L:L, P:P, Q:Q}; }
function feasibleThetaRange(a,b,c,d){ var rMax=b+c, rMin=Math.abs(b-c); var coHi=(a*a + d*d - rMin*rMin)/(2*a*d); var coLo=(a*a + d*d - rMax*rMax)/(2*a*d); var clamp=function(x){ return Math.max(-1,Math.min(1,x)); }; var lo=Math.acos(clamp(coHi)); var hi=Math.acos(clamp(coLo)); if(isNaN(lo)||isNaN(hi)) return []; if(lo>hi) return []; return [ [lo, hi], [2*Math.PI - hi, 2*Math.PI - lo] ]; }
function solvePose(a,b,c,d,theta,asm){ var O2={x:0,y:0}, O4={x:d,y:0}; var B={x:a*Math.cos(theta), y:a*Math.sin(theta)}; var inter = circleIntersections(B.x,B.y,b, O4.x,O4.y,c); if(inter.length===0) return null; var C=choosePoint(inter[0], inter[1], asm); var phi=Math.atan2(C.y-O4.y, C.x-O4.x); return {O2:O2,O4:O4,B:B,C:C,phi:phi}; }
function computeAll(a,b,c,d,asm){ var intervals=feasibleThetaRange(a,b,c,d); if(intervals.length===0) return {ok:false, msg:'几何不可装配（两圆始终不相交/相离）', intervals:[]}; var poses=[]; var phis=[]; var thetas=[]; var sampleN=720; for(var k=0;k<intervals.length;k++){ var t0=intervals[k][0], t1=intervals[k][1]; for(var i=0;i<=sampleN;i++){ var t = t0 + (t1-t0)*i/sampleN; var pose=solvePose(a,b,c,d,t,asm); if(!pose) continue; poses.push(pose); phis.push(pose.phi); thetas.push(t); } } if(poses.length<3) return {ok:false, msg:'采样失败，检查参数', intervals:intervals}; var phiMin=Infinity, phiMax=-Infinity; for(var j=0;j<phis.length;j++){ var p=phis[j]; if(p<phiMin) phiMin=p; if(p>phiMax) phiMax=p; } var swing = deg(phiMax - phiMin); var th1 = deg(thetas[0]), th2 = deg(thetas[thetas.length-1]); var ph1 = deg(phis[0]), ph2 = deg(phis[phis.length-1]); var limspan = ((th2 - th1 + 360) % 360); var inc=0, dec=0; for(var m=1;m<phis.length;m++){ var dphi = phis[m]-phis[m-1]; var dth = thetas[m]-thetas[m-1]; if(dphi>0) inc += dth; else if(dphi<0) dec += dth; } var K = (inc>0 && dec>0)? (dec/inc) : NaN; var hi = intervals[0][1], lo = intervals[0][0]; var coverage = Math.max(0, Math.min(1, (2*(hi-lo)) / (2*Math.PI))); var crankAFull = coverage > 0.999; return {ok:true, intervals:intervals, poses:poses, thetas:thetas, phis:phis, swing:swing, th1:th1, th2:th2, ph1:ph1, ph2:ph2, limspan:limspan, K:K, coverageA:coverage, crankAFull:crankAFull, classify: classifyGrashof(a,b,c,d)}; }
function makeSlider(id,label,init, min,max, step){ if(step===void 0) step=0.1; var wrap=document.createElement('div'); wrap.className='col-6'; wrap.innerHTML='<label>'+label+' <small class="muted">'+id+'（拖动或输入）</small></label>\n  <div class="row" style="gap:8px;align-items:center">\n    <input id="sl-'+id+'" type="range" min="'+min+'" max="'+max+'" value="'+init+'" step="'+step+'" class="grow" />\n    <input id="in-'+id+'" type="number" value="'+init+'" step="'+step+'" style="width:110px"/>\n  </div>'; return wrap; }
function estimateRange(known){ var arr=[]; for(var i=0;i<known.length;i++){ if(known[i]!=null) arr.push(known[i]); } var base = arr.length? (arr.reduce(function(a,b){return a+b;},0)/arr.length) : 100; var min = Math.max(0.1, base*0.2); var max = base*3.5; return {min:min, max:max, init: base*0.8}; }
function solveUnknownByTargets(unknownId, a,b,c,d, asm, wantSwing, targetSwing, wantK, targetK){ var rng = estimateRange([a,b,c,d]); var min=rng.min, max=rng.max; var N=220; var bestVal=null, bestErr=Infinity; var setVal=function(val){ if(unknownId==='a') a=val; else if(unknownId==='b') b=val; else if(unknownId==='c') c=val; else d=val; }; var evalErr=function(val){ setVal(val); var r = computeAll(a,b,c,d,asm); if(!r.ok) return Infinity; var err=0; if(wantSwing && isFinite(r.swing)){ var tS = (targetSwing!=null)? targetSwing : r.swing; err += Math.pow((r.swing - tS)/Math.max(1,tS),2); } if(wantK && isFinite(r.K)){ var tK = (targetK!=null)? targetK : r.K; err += Math.pow((r.K - tK)/Math.max(1,tK),2); } if(!wantSwing && !wantK) err = 0; return err; }; for(var i2=0;i2<=N;i2++){ var v = min + (max-min)*i2/N; var e = evalErr(v); if(e<bestErr){ bestErr=e; bestVal=v; } } if(bestVal==null || !isFinite(bestErr)) return null; var L=Math.max(min, bestVal - (max-min)*0.1), R=Math.min(max, bestVal + (max-min)*0.1); for(var iter=0; iter<25; iter++){ var m1 = L + (R-L)/3, m2 = R - (R-L)/3; var e1 = evalErr(m1), e2 = evalErr(m2); if(e1<e2){ R=m2; bestVal=m1; bestErr=e1; } else { L=m1; bestVal=m2; bestErr=e2; } } return {value:bestVal, error:bestErr}; }
function updateJSON(state){ var res = state.res || null; var out={ input:{ a:state.a, b:state.b, c:state.c, d:state.d, assembly:state.asm }, results:{ swing_deg: (res && isFinite(res.swing))? res.swing : null, limit_crank_span_deg: (res && isFinite(res.limspan))? res.limspan : null, quick_return_K: (res && isFinite(res.K))? res.K : null, crank_a_full: res? !!res.crankAFull : null, crank_a_theta_coverage: res? res.coverageA : null, theta1_deg: res? res.th1 : null, phi1_deg: res? res.ph1 : null, theta2_deg: res? res.th2 : null, phi2_deg: res? res.ph2 : null, grashof: res? res.classify : null, } }; setText('#json', JSON.stringify(out, null, 2)); }
function updateSVG(a,b,c,d,asm,theta){ var pose=solvePose(a,b,c,d,rad(theta),asm); var linkA=$('#linkA'), linkB=$('#linkB'), linkC=$('#linkC'), linkD=$('#linkD'); var svg=$('#svg'); var marker=$('#dot'); var markerCircle = $('#dot circle'); var O2={x:0,y:0}, O4={x:d,y:0}; if(!svg||!linkA||!linkB||!linkC||!linkD) return; linkD.setAttribute('x1', O2.x); linkD.setAttribute('y1', O2.y); linkD.setAttribute('x2', O4.x); linkD.setAttribute('y2', O4.y); if(!pose){ linkA.setAttribute('x1',O2.x); linkA.setAttribute('y1',O2.y); linkA.setAttribute('x2',O2.x); linkA.setAttribute('y2',O2.y); linkB.setAttribute('x1',O2.x); linkB.setAttribute('y1',O2.y); linkB.setAttribute('x2',O2.x); linkB.setAttribute('y2',O2.y); linkC.setAttribute('x1',O4.x); linkC.setAttribute('y1',O4.y); linkC.setAttribute('x2',O4.x); linkC.setAttribute('y2',O4.y); } else { var B=pose.B, C=pose.C; linkA.setAttribute('x1',O2.x); linkA.setAttribute('y1',O2.y); linkA.setAttribute('x2',B.x);  linkA.setAttribute('y2',B.y); linkB.setAttribute('x1',B.x);  linkB.setAttribute('y1',B.y); linkB.setAttribute('x2',C.x);  linkB.setAttribute('y2',C.y); linkC.setAttribute('x1',O4.x); linkC.setAttribute('y1',O4.y); linkC.setAttribute('x2',C.x);  linkC.setAttribute('y2',C.y); } var pts = pose ? [O2,O4,pose.B,pose.C] : [O2,O4]; var minX=Infinity,minY=Infinity,maxX=-Infinity,maxY=-Infinity; for(var i=0;i<pts.length;i++){ var p=pts[i]; if(p.x<minX)minX=p.x; if(p.x>maxX)maxX=p.x; if(p.y<minY)minY=p.y; if(p.y>maxY)maxY=p.y; } minX = Math.min(minX, -d*0.1); maxX = Math.max(maxX, d*1.1); var w=maxX-minX, h=maxY-minY; var span=Math.max(w,h); var pad = Math.max(5, span*0.15); var vbX = (minX-pad).toFixed(2), vbY=(minY-pad).toFixed(2), vbW=(w+pad*2||120).toFixed(2), vbH=(h+pad*2||120).toFixed(2); svg.setAttribute('viewBox', vbX+' '+vbY+' '+vbW+' '+vbH); var stroke = Math.max(1.1, Math.min(3.5, span/120)); var r = Math.max(1.2, Math.min(4.0, span/140)); var mech=$('#mech'); if(mech) mech.setAttribute('stroke-width', stroke.toFixed(2)); if(marker){ marker.setAttribute('markerWidth', (r*2).toFixed(1)); marker.setAttribute('markerHeight', (r*2).toFixed(1)); marker.setAttribute('refX', r.toFixed(1)); marker.setAttribute('refY', r.toFixed(1)); } if(markerCircle){ markerCircle.setAttribute('r', r.toFixed(2)); } }

// ====== 主流程 ======
function runCalc(){ var a=parseVal('#a'), b=parseVal('#b'), c=parseVal('#c'), d=parseVal('#d'); var asm = getAsm(); var unknown=[]; if(!a) unknown.push('a'); if(!b) unknown.push('b'); if(!c) unknown.push('c'); if(!d) unknown.push('d'); var useSwingEl=$('#useSwing'), swingTargetEl=$('#swingTarget'); var wantSwing = !!(useSwingEl && useSwingEl.checked && parseVal('#swingTarget')!=null); var targetSwing = wantSwing? parseFloat(swingTargetEl.value) : null; var useKEl=$('#useK'), KTargetEl=$('#KTarget'); var wantK = !!(useKEl && useKEl.checked && parseVal('#KTarget')!=null); var targetK = wantK? parseFloat(KTargetEl.value) : null; var sliderBox=$('#sliders'); var container=$('#sliderFields'); if(container) container.innerHTML=''; var va=a, vb=b, vc=c, vd=d; if(unknown.length){ if(sliderBox) sliderBox.style.display='block'; var range=estimateRange([a,b,c,d]); var min=range.min, max=range.max, init=range.init; for(var u=0;u<unknown.length;u++){ var id=unknown[u]; var label = id==='a'? '曲柄 a (mm)' : id==='b'? '连杆 b (mm)' : id==='c'? '摇杆 c (mm)' : '机架 d (mm)'; var el=makeSlider(id,label, init.toFixed(2), min.toFixed(2), max.toFixed(2), 0.01); if(container) container.appendChild(el); }
    unknown.forEach(function(id){ var sl = $('#sl-'+id); var input = $('#in-'+id); var sync=function(v){ if(sl) sl.value=v; if(input) input.value=v; recalc(); }; if(sl) sl.addEventListener('input', function(e){ sync(e.target.value); }); if(input) input.addEventListener('input', function(e){ sync(e.target.value); }); });
    var inA=$('#in-a'), inB=$('#in-b'), inC=$('#in-c'), inD=$('#in-d');
    if(va==null) va = inA? parseFloat(inA.value) : va; if(vb==null) vb = inB? parseFloat(inB.value) : vb; if(vc==null) vc = inC? parseFloat(inC.value) : vc; if(vd==null) vd = inD? parseFloat(inD.value) : vd;
    if((wantSwing || wantK) && unknown.length===1){ var uid = unknown[0]; var sol = solveUnknownByTargets(uid, va,vb,vc,vd, asm, wantSwing, targetSwing, wantK, targetK); if(sol && isFinite(sol.value)){ var v = parseFloat(niceNum(sol.value,4)); if(uid==='a'){ va=v; if($('#sl-a')) $('#sl-a').value=v; if($('#in-a')) $('#in-a').value=v; } else if(uid==='b'){ vb=v; if($('#sl-b')) $('#sl-b').value=v; if($('#in-b')) $('#in-b').value=v; } else if(uid==='c'){ vc=v; if($('#sl-c')) $('#sl-c').value=v; if($('#in-c')) $('#in-c').value=v; } else { vd=v; if($('#sl-d')) $('#sl-d').value=v; if($('#in-d')) $('#in-d').value=v; } } }
  } else { if(sliderBox) sliderBox.style.display='none'; }

  if(!(va&&vb&&vc&&vd)){
    setHTML('#classify','<span class="warn">请至少提供三个已知并用滑块/目标补全到四个长度</span>');
    setText('#crankA','—'); setText('#crankACov','—');
    updateJSON({a:va,b:vb,c:vc,d:vd,asm:asm,res:null});
    return;
  }
  var res = computeAll(va,vb,vc,vd,asm);
  if(!res.ok){
    setText('#swing','—'); setText('#qrr','—');
    setHTML('#classify','<span class="warn">'+res.msg+'</span>');
    updateSVG(va,vb,vc,vd,asm, parseFloat( ( $('#thetaRange')||{value:0} ).value ));
    updateJSON({a:va,b:vb,c:vc,d:vd,asm:asm,res:null});
    return;
  }
  setText('#swing', niceNum(res.swing,2));
  setText('#qrr', isNaN(res.K)? '—' : niceNum(res.K,3));
  var g=res.classify;
  var cond = g.type==='Grashof' ? '<span class="ok">'+g.type+'</span>' : '<span class="warn">'+g.type+'</span>';
  setHTML('#classify', cond);
  var pair = res.intervals[0]; var t0=pair[0], t1=pair[1]; var mid = deg((t0+t1)/2);
  var tr=$('#thetaRange'); if(tr){ tr.min=0; tr.max=360; tr.value=mid; setText('#thetaLbl', niceNum(mid,2)); }
  updateSVG(va,vb,vc,vd,asm, mid);
  setHTML('#crankA', res.crankAFull? '<span class="ok">是</span>' : '<span class="warn">否</span>');
  setText('#crankACov', (res.coverageA*100).toFixed(1)+'%');
  updateJSON({a:va,b:vb,c:vc,d:vd,asm:asm,res:res});
}

function recalc(){
  var asm = getAsm();
  var a = readInOr('#in-a','#a'); var b = readInOr('#in-b','#b'); var c = readInOr('#in-c','#c'); var d = readInOr('#in-d','#d');
  if(a&&b&&c&&d){
    var theta=parseFloat( ( $('#thetaRange')||{value:0} ).value );
    var res = computeAll(a,b,c,d,asm);
    if(res.ok){
      setText('#swing', niceNum(res.swing,2));
      setText('#qrr', isNaN(res.K)? '—' : niceNum(res.K,3));
      var g=res.classify; var cond = g.type==='Grashof' ? '<span class="ok">'+g.type+'</span>' : '<span class="warn">'+g.type+'</span>';
      setHTML('#classify', cond);
      updateSVG(a,b,c,d,asm, theta);
      setHTML('#crankA', res.crankAFull? '<span class="ok">是</span>' : '<span class="warn">否</span>');
      setText('#crankACov', (res.coverageA*100).toFixed(1)+'%');
      updateJSON({a:a,b:b,c:c,d:d,asm:asm,res:res});
    }
  } else {
    updateSVG(a||0,b||0,c||0,d||0,asm, parseFloat( ( $('#thetaRange')||{value:0} ).value ));
    setText('#crankA','—'); setText('#crankACov','—');
    updateJSON({a:a,b:b,c:c,d:d,asm:asm,res:null});
  }
}

// ====== 事件绑定 ======
function wire(){ if(wire._done) return; wire._done=true;
  var calc=$('#calc'); if(calc) calc.addEventListener('click', runCalc);
  var reset=$('#reset'); if(reset) reset.addEventListener('click', function(){
    ['a','b','c','d'].forEach(function(id){ var el=$('#'+id); if(el) el.value=''; });
    var sliders=$('#sliders'), fields=$('#sliderFields'); if(sliders) sliders.style.display='none'; if(fields) fields.innerHTML='';
    var st=$('#swingTarget'), kt=$('#KTarget'), us=$('#useSwing'), uk=$('#useK'); if(st) st.value=''; if(kt) kt.value=''; if(us) us.checked=false; if(uk) uk.checked=false;
    setText('#swing','—'); setText('#qrr','—'); setText('#classify','—'); setText('#json','{}');
    updateSVG(0,0,0,80,getAsm(), 0);
  });
  var tr=$('#thetaRange'); if(tr) tr.addEventListener('input', function(e){
    var theta=parseFloat(e.target.value); setText('#thetaLbl', niceNum(theta,2));
    var a = readInOr('#in-a','#a'); var b = readInOr('#in-b','#b'); var c = readInOr('#in-c','#c'); var d = readInOr('#in-d','#d'); var asm = getAsm();
    if(a&&b&&c&&d) updateSVG(a,b,c,d,asm, theta);
  });
  var asms=$$('input[name="asm"]'); for(var i=0;i<asms.length;i++){ asms[i].addEventListener('change', function(){ recalc(); }); }
  var copy=$('#copy'); if(copy) copy.addEventListener('click', function(){ var text=( $('#json')||{} ).textContent||''; if(navigator.clipboard && navigator.clipboard.writeText){ navigator.clipboard.writeText(text); } var btn=$('#copy'); if(btn){ var bak=btn.textContent; btn.textContent='已复制'; setTimeout(function(){ btn.textContent=bak; },900); } });
  var runBtn=$('#runTests'); if(runBtn) runBtn.addEventListener('click', runTests);
  // 默认值 & 首算
  var a=$('#a'), b=$('#b'), c=$('#c'), d=$('#d'); if(a) a.value='30'; if(b) b.value='70'; if(c) c.value='60'; if(d) d.value='90';
  runCalc();
}
if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', wire); } else { wire(); }

// ====== 内置测试（更新以匹配 UI 变更） ======
function log(line){ var el=$('#testLog'); if(el) el.textContent += '\n'+line; }
function clearLog(){ setText('#testLog','(测试输出)'); }
function approxEqual(a,b,tol){ if(tol===void 0) tol=1e-3; return Math.abs(a-b) <= tol*Math.max(1,Math.abs(b)); }
function runTests(){ clearLog(); var pass=0, fail=0; function assert(name, cond){ if(cond){ pass++; log('✅ '+name);} else { fail++; log('❌ '+name);} }
  // 用例1：基本几何可装配
  var res = computeAll(30,70,60,90,'open');
  assert('computeAll 返回 ok', res.ok===true);
  assert('摆角 > 0', res.swing>0);
  assert('K 合法（>0）', !isNaN(res.K) && res.K>0);
  // 用例2：Grashof 判别边界 S+L=P+Q
  var g = classifyGrashof(10,20,30,40); // 10+40 == 20+30
  assert('Grashof 边界条件判定', g.type==='Grashof');
  // 用例3：可行 θ 区间数量
  var itv = feasibleThetaRange(30,70,60,90);
  assert('可行区间数量 >=1', Array.isArray(itv) && itv.length>=1);
  // DOM 元素存在性（按当前 UI）
  assert('#swing 存在', !!document.getElementById('swing'));
  assert('#qrr 存在', !!document.getElementById('qrr'));
  assert('#classify 存在', !!document.getElementById('classify'));
  // runCalc 在空页面状态不抛错
  try{ runCalc(); assert('runCalc 可调用且不抛错', true); }catch(e){ assert('runCalc 可调用且不抛错', false); }
  log('\n总结：通过 '+pass+' 项，未通过 '+fail+' 项'); }
window.runTests = runTests;
})();
</script>
</body>
</html>
